<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ruoyi.system.mapper.ScheduleMapper">

    <resultMap id="ScheduleResult" type="com.ruoyi.system.domain.Schedule">
        <id property="scheduleId" column="schedule_id"/>
        <result property="courseId" column="course_id"/>
        <result property="teacherId" column="teacher_id"/>
        <result property="clazzId" column="clazz_id"/>
        <result property="packageId" column="package_id"/>
        <result property="weekDay" column="week_day"/>
        <result property="startTime" column="start_time"/>
        <result property="endTime" column="end_time"/>
        <result property="autoFlag" column="auto_flag"/>
        <result property="createTime" column="create_time"/>

        <!-- 扩展字段 -->
        <result property="courseName" column="course_name"/>
        <result property="teacherName" column="teacher_name"/>
        <result property="clazzName" column="clazz_name"/>
        <result property="packageName" column="package_name"/>
        <result property="startWeek" column="start_week"/>
        <result property="endWeek" column="end_week"/>
    </resultMap>

    <!-- 查询单个 -->
    <select id="selectScheduleByScheduleId" parameterType="long" resultMap="ScheduleResult">
        SELECT s.schedule_id,
               s.course_id,
               c.course_name,
               s.teacher_id,
               t.teacher_name,
               s.clazz_id,
               cl.clazz_name,
               s.package_id,
               p.package_name,
               s.week_day,
               s.start_time,
               s.end_time,
               s.auto_flag,
               s.start_week,
               s.end_week,
               s.create_time
        FROM schedule s
                 LEFT JOIN course c ON s.course_id = c.course_id
                 LEFT JOIN teacher t ON s.teacher_id = t.teacher_id
                 LEFT JOIN clazz cl ON s.clazz_id = cl.clazz_id
                 LEFT JOIN course_package p ON s.package_id = p.id
        WHERE s.schedule_id = #{scheduleId}
    </select>


    <!-- 查询列表 -->
    <select id="selectScheduleList" parameterType="Schedule" resultMap="ScheduleResult">
        SELECT s.schedule_id,
        s.course_id,
        c.course_name,
        s.teacher_id,
        t.teacher_name,
        s.clazz_id,
        cl.clazz_name,
        s.package_id,
        p.package_name,
        s.week_day,
        s.start_time,
        s.end_time,
        s.auto_flag,
        s.start_week,
        s.end_week,
        s.create_time
        FROM schedule s
        LEFT JOIN course c ON s.course_id = c.course_id
        LEFT JOIN teacher t ON s.teacher_id = t.teacher_id
        LEFT JOIN clazz cl ON s.clazz_id = cl.clazz_id
        LEFT JOIN course_package p ON s.package_id = p.id
        <where>
            <if test="clazzId != null">AND s.clazz_id = #{clazzId}</if>
            <if test="weekNo != null">
                AND s.start_week &lt;= #{weekNo}
                AND s.end_week &gt;= #{weekNo}
            </if>
        </where>
    </select>


    <!-- 插入 -->
    <insert id="insertSchedule" parameterType="com.ruoyi.system.domain.Schedule" useGeneratedKeys="true"
            keyProperty="scheduleId">
        insert into schedule(course_id, teacher_id, clazz_id, package_id, week_day, start_time, end_time, auto_flag, start_week, end_week, create_time)
        values (#{courseId}, #{teacherId}, #{clazzId}, #{packageId}, #{weekDay}, #{startTime}, #{endTime}, #{autoFlag}, #{startWeek}, #{endWeek}, now())
    </insert>

    <!-- 更新 -->
    <update id="updateSchedule" parameterType="com.ruoyi.system.domain.Schedule">
        update schedule
        <set>
            <if test="courseId != null">course_id = #{courseId},</if>
            <if test="teacherId != null">teacher_id = #{teacherId},</if>
            <if test="clazzId != null">clazz_id = #{clazzId},</if>
            <if test="packageId != null">package_id = #{packageId},</if>
            <if test="weekDay != null">week_day = #{weekDay},</if>
            <if test="startTime != null">start_time = #{startTime},</if>
            <if test="endTime != null">end_time = #{endTime},</if>
            <if test="autoFlag != null">auto_flag = #{autoFlag},</if>
            <if test="startWeek != null">start_week = #{startWeek},</if>
            <if test="endWeek != null">end_week = #{endWeek},</if>
        </set>
        where schedule_id = #{scheduleId}
    </update>

    <!-- 删除单个 -->
    <delete id="deleteScheduleByScheduleId" parameterType="long">
        delete
        from schedule
        where schedule_id = #{scheduleId}
    </delete>

    <!-- 批量删除 -->
    <delete id="deleteScheduleByScheduleIds" parameterType="long">
        delete from schedule
        where schedule_id in
        <foreach collection="array" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <!-- 冲突检测 -->
    <select id="checkConflict" parameterType="com.ruoyi.system.domain.Schedule" resultType="int">
        select count(1)
        from schedule
        where week_day = #{weekDay}
        and (teacher_id = #{teacherId} or clazz_id = #{clazzId})
        and (start_time &lt; #{endTime} and end_time > #{startTime})
        and (start_week &lt;= #{endWeek} and end_week >= #{startWeek})
        <if test="scheduleId != null">and schedule_id != #{scheduleId}</if>
    </select>



    <!-- 班级 + 周次 -->
    <select id="selectByClazzAndWeek" resultType="com.ruoyi.system.domain.Schedule">
        SELECT s.schedule_id,
               s.course_id,
               c.course_name,
               s.teacher_id,
               t.teacher_name,
               s.clazz_id,
               cl.clazz_name,
               s.package_id,
               p.package_name,
               s.week_day,
               s.start_time,
               s.end_time,
               s.auto_flag,
               s.start_week,
               s.end_week,
               s.create_time
        FROM schedule s
                 LEFT JOIN course c ON s.course_id = c.course_id
                 LEFT JOIN teacher t ON s.teacher_id = t.teacher_id
                 LEFT JOIN clazz cl ON s.clazz_id = cl.clazz_id
                 LEFT JOIN course_package p ON s.package_id = p.id
        WHERE s.clazz_id = #{clazzId}
          AND s.start_week &lt;= #{weekNo}
          AND s.end_week &gt;= #{weekNo}
        ORDER BY s.week_day, s.start_time
    </select>



</mapper>
